<project name="JTablet2" default="jars" basedir=".">
	<description>
        JTablet2
    </description>

	<!-- set global properties for this build -->
	<taskdef resource="proguard/ant/task.properties" classpath="lib/proguard.jar" />

	<property name="src"					location="src"/>
	<property name="src.gen"				location="src-gen"/>
	<property name="src.gen.thin"			location="src-gen-thin"/>

	<!-- these need to match (todo: generate from one property) -->
	<property name="src.gen.java"			location="${src.gen}/java/cello/repackaged/jpen"/>
	<property name="src.jpen.package"		value="cello.repackaged.jpen"/>
	<property name="src.jpen.package_"	value="cello_repackaged_jpen"/>

	<property name="src.gen.native"		location="src-gen/native"/>
	<property name="src.demo"				location="src-demo"/>
	<property name="src.installer"		location="src-installer"/>
	<property name="src.jpen"				location="../jpen/src/main/java"/>
	<property name="src.jpen.native"		location="../jpen/src/main/c"/>
	<property name="src.jpen.resources"	location="../jpen/src/main/resources"/>


	<property name="build.version.file"	location="build/svn.version"/>

	<property name="build.jtablet"		location="build/jtablet"/>
	<property name="build.jpen"			location="build/jpen"/>
	<property name="build.jtablet.jpen"	location="build/jtablet-jpen"/>
	<property name="build.jtablet.thin"	location="build/jtablet-thin"/>
	<property name="build.demo"			location="build/demo"/>
	<property name="build.installer"		location="build/installer"/>

	<property name="docs.api"				location="docs/api"/>

	<property name="dist"  				location="dist"/>
	<property name="lib.dir"     			location="lib"/>

	<property name="ext.name"				value="JTablet"/>

	<property name="spec.title"			value="JTablet 2"/>
	<property name="spec.vendor"			value="Cellosoft"/>
	<property name="spec.version"			value="1.2.0"/>

	<property name="impl.title"			value="JTablet 2"/>
	<property name="impl.vendor"			value="Cellosoft"/>
	<property name="impl.vendor.id"		value="cello"/>
	<property name="impl.version"			value="1.2.0-alpha"/>

	<condition property="platform" value="mac">
		<os family="mac"/>
	</condition>
	<condition property="platform" value="windows">
		<os family="windows"/>
	</condition>
	<condition property="platform" value="unix">
		<and>
			<os family="unix"/>
			<not>
				<os family="mac"/>
			</not>
		</and>
	</condition>



	<target name="init" depends="svn.version">
		<tstamp/>
		<property name="dist.version"			value="${dist}/${DSTAMP}-${svn.version}"/>
		<mkdir dir="${dist.version}"/>
	</target>

	<target name="svn.version" description="Sets the buildversion for the current build">
		<!--<exec executable="svnversion" spawn="false" dir="." outputproperty="svn.version" errorproperty="svn.version.error"></exec>-->
		<property name="svn.version" value="dev"/>
	</target>

	<target name="jtabletjpen.gen.java" depends="init" description="repackage jpen java source for jtablet" >
		<mkdir dir="${src.gen.java}"/>
		<copy todir="${src.gen.java}">
			<fileset dir="${src.jpen}/jpen">
				<include name="**/*.java" />
				<exclude name="demo/**" />
			</fileset>
		</copy>
		<replace dir="${src.gen.java}">
			<replacefilter
				token=" jpen."
		  	  	value=" ${src.jpen.package}."/>
			<replacefilter
				token="package jpen;"
		  	  	value="package ${src.jpen.package};"/>
		</replace>
	</target>
	<target name="jtabletjpen.compile" depends="jtabletjpen.gen.java" description="compile the repackaged jpen source" >
		<mkdir dir="${build.jtablet.jpen}"/>
		<javac 
			srcdir="${src.gen}/java"          
			includes="**"
			destdir="${build.jtablet.jpen}" 
			source="1.5" 
			target="1.5"
			debug="on"/>
	</target>

	<target name="jtabletjpen.gen.native" depends="init" description="repackage jpen native source for jtablet" >
		<mkdir dir="${src.gen.native}"/>
		<copy todir="${src.gen.native}">
			<fileset dir="${src.jpen.native}">
				<include name="**/*" />
			</fileset>
		</copy>
		<replace dir="${src.gen.native}">
			<replacefilter
				token="Java_jpen_"
		  	  	value="Java_${src.jpen.package_}_"/>
		</replace>
	</target>

	<target name="jtabletjpen.compile.osx" depends="jtabletjpen.gen.native" description="compile the jpen native source for mac os x" >
		<exec
	    	executable="xcodebuild"
	    	failonerror="true"
	    	dir="${src.gen.native}/osx">
			<arg value="-target"/>
			<arg value="jnilib"/>
		</exec>
		<copy tofile="${dist.version}/libjtablet2.jnilib">
			<fileset dir="${src.gen.native}/osx/build/Release">
				<include name="*.jnilib"/>
			</fileset>
		</copy>
	</target>

	<!-- MAIN JTABLET JAR -->

	<path id="jtablet.classpath">
		<pathelement location="${build.jtablet.jpen}"/>
	</path>

	<target name="jtablet.compile" depends="init,jtabletjpen.compile" description="compile the source" >
		<mkdir dir="${build.jtablet}"/>
		<javac 
			srcdir="${src}"          
			includes="**"
			destdir="${build.jtablet}" 
			source="1.5" 
			target="1.5"
			debug="on"
			classpathref="jtablet.classpath"/>
	</target>


	<target name="jtablet.jar" depends="svn.version,jtablet.compile,jtabletjpen.compile" description="generate the initial jtablet jar" >
		<copy todir="${build.jtablet}">
			<fileset dir="${build.jtablet.jpen}">
				<include name="**/*" />
			</fileset>
		</copy>
		<jar 
			jarfile="${dist.version}/jtablet2.original.jar"
			includes="cello/**"
	    	level="9"
			basedir="${build.jtablet}">
			<manifest>
				<attribute name="Built-By" value="Marcello"/>
				<attribute name="Extension-Name" 			value="${ext.name}"/>
				<attribute name="Specification-Title" 		value="${spec.title}"/>
				<attribute name="Specification-Vendor" 		value="${spec.vendor}"/>
				<attribute name="Specification-Version" 	value="${spec.version}"/>
				<attribute name="Implementation-Title" 		value="${impl.title}"/>
				<attribute name="Implementation-Vendor" 	value="${impl.vendor}"/>
				<attribute name="Implementation-Vendor-Id" 	value="${impl.vendor.id}"/>
				<attribute name="Implementation-Version" 	value="${impl.version}_${DSTAMP}_${svn.version}"/>
				<section name="cello/jtablet/impl/">
					<attribute name="Sealed" value="true"/>
				</section>
			</manifest>
		</jar>
	</target>

	<target name="jtablet.jar.compress" depends="jtablet.jar" description="compress the jtablet jar" >
		<dependset>
			<srcfilelist dir="." files="proguard.conf"/>
			<targetfileset dir="${dist.version}" includes="jtablet2.original.jar"/>
		</dependset>

		<proguard configuration="proguard.conf">
			<libraryjar location="/System/Library/Frameworks/JavaVM.framework/Versions/1.6.0/Classes/classes.jar" filter="java/**,javax/**"/>
			<injar  file="${dist.version}/jtablet2.original.jar" />
			<outjar file="${dist.version}/jtablet2.compressed.jar" />
		</proguard>
	</target>




	<target name="jtablet.thin.gen" depends="init" description="compile the thin JTablet jar">
		<mkdir dir="${src.gen.thin}"/>
		<copy todir="${src.gen.thin}">
			<fileset dir="${src}">
				<include name="**/*" />
				<exclude name="cello/tablet/**" />
			</fileset>
		</copy>
		<replace dir="${src.gen.thin}">
			<replacefilter
				token="IS_PLUGIN = true"
		  	  	value="IS_PLUGIN = false"/>
		</replace>
	</target>

	<target name="jtablet.thin.compile" depends="init,jtablet.thin.gen,jtabletjpen.compile" description="compile the thin version of JTablet">
		<mkdir dir="${build.jtablet.thin}"/>
		<javac 
			srcdir="${src.gen.thin}"          
			includes="**"
			destdir="${build.jtablet.thin}" 
			source="1.5" 
			target="1.5"
			debug="on"
			classpathref="jtablet.classpath"/>
	</target>


	<target name="jtablet.thin.jar" depends="svn.version,jtablet.thin.compile,jtabletjpen.compile" description="generate the initial thin jtablet jar" >
		<copy todir="${build.jtablet.thin}">
			<fileset dir="${build.jtablet.jpen}">
				<include name="**/*" />
			</fileset>
		</copy>
		<jar 
			jarfile="${dist.version}/jtablet2.thin.original.jar"
			includes="cello/**"
	    	level="9"
			basedir="${build.jtablet.thin}">
			<manifest>
				<attribute name="Built-By" value="Marcello"/>
				<attribute name="Extension-Name" 			value="${ext.name}"/>
				<attribute name="Specification-Title" 		value="${spec.title}"/>
				<attribute name="Specification-Vendor" 		value="${spec.vendor}"/>
				<attribute name="Specification-Version" 	value="${spec.version}"/>
				<attribute name="Implementation-Title" 		value="${impl.title}"/>
				<attribute name="Implementation-Vendor" 	value="${impl.vendor}"/>
				<attribute name="Implementation-Vendor-Id" 	value="${impl.vendor.id}"/>
				<attribute name="Implementation-Version" 	value="${impl.version}_${DSTAMP}_${svn.version}-thin"/>
				<section name="cello/jtablet/impl/">
					<attribute name="Sealed" value="true"/>
				</section>
			</manifest>
		</jar>
	</target>

	<target name="jtablet.thin.jar.compress" depends="jtablet.thin.jar" description="compress the thin jtablet jar" >
		<dependset>
			<srcfilelist dir="." files="proguard.conf"/>
			<targetfileset dir="${dist.version}" includes="jtablet2.thin.original.jar"/>
		</dependset>
		<proguard configuration="proguard.conf">
			<libraryjar location="/System/Library/Frameworks/JavaVM.framework/Versions/1.6.0/Classes/classes.jar" filter="java/**,javax/**"/>
			<injar  file="${dist.version}/jtablet2.thin.original.jar" />
			<outjar file="${dist.version}/jtablet2.thin.compressed.jar" />
		</proguard>
	</target>




	<target name="jtablet.install.mac" depends="jtablet.jar,jtabletjpen.compile.osx">
		<mkdir dir="${user.home}/Library/Java/Extensions"/>
		<mkdir dir="${user.home}/.jtablet"/>
		<copy 
			file="${dist.version}/jtablet2.original.jar" 
			tofile="${user.home}/Library/Java/Extensions/jtablet.jar"/>

		<copy 
			file="${dist.version}/libjtablet2.jnilib" 
			todir="${user.home}/.jtablet"/>
	</target>


	<!-- demo package -->
	<path id="demo.classpath">
		<!-- <fileset dir="lib" includes="**/*.jar"/> -->
		<pathelement location="${build.jtablet}"/>
	</path>

	<target name="demo.compile" depends="init,jtablet.compile" description="compile the source" >
		<mkdir dir="${build.demo}"/>
		<javac 
		srcdir="${src.demo}"          
		includes="**"
		destdir="${build.demo}" 
		source="1.5" 
		target="1.5"
		debug="on"
		classpathref="demo.classpath"/>
	</target>

	<target name="demo.jar" depends="demo.compile">
		<jar 
		jarfile="${dist.version}/jtablet2-demo.original.jar"
		includes="cello/**"
    	level="9"
    	basedir="${build.demo}">
			<manifest>
				<attribute name="Main-Class" value="cello.demo.jtablet.DemoApplet" />
				<attribute name="Built-By" value="Marcello"/>
				<attribute name="Sealed" value="true"/>
			</manifest>
		</jar>
	</target>
	<target name="demo.run" depends="demo.jar">
		<java           
    	fork="true"
  		jar="${dist.version}/jtablet2-demo.original.jar"/>
	</target>


	<!-- INSTALLER -->
	<path id="classpath.installer">
		<fileset dir="lib" includes="**/*.jar"/>
	</path>
	<target name="installer.compile" depends="init" description="compile the source" >
		<mkdir dir="${build.installer}"/>
		<javac 
		srcdir="${src.installer}"          
		includes="**"
		destdir="${build.installer}" 
		source="1.5" 
		target="1.5"
		debug="on"
		classpathref="classpath.installer"/>
	</target>

	<target name="installer.jar" depends="installer.compile">
		<jar 
		jarfile="${dist.version}/jtablet2-installer.original.jar"
		includes="cello/jtablet/installer**"
    	level="9"
    	basedir="${build.installer}">
		</jar>
	</target>


	<target name="jars" depends="jtablet.jar,demo.jar,installer.jar" >
	</target>


	<target name="genkey">
		<genkey 
    	alias="jtablet2" 
    	storepass="notsecureatall5936510" 
		keypass="notsecureatall5936510"
    	validity="365">
			<dname>
				<param name="CN" value="JTablet Installer"/>
				<param name="O"  value="Cellosoft"/>
				<param name="C"  value="US"/>
			</dname>
		</genkey>
	</target>



	<target name="exttest" depends="demo.compile">
		<jar 
			jarfile="${dist.version}/exttest-applet.jar"
			includes="cello/demo/jtablet/ext/TestApplet.class"
	    	level="9"
	    	basedir="${build.demo}">
			<manifest>
				<attribute name="Built-By" value="Marcello"/>
			</manifest>
		</jar>
		<jar 
			jarfile="${dist.version}/exttest-other.jar"
			includes="cello/demo/jtablet/ext/OtherClass.class"
	    	level="9"
	    	basedir="${build.demo}">
			<manifest>
				<attribute name="Built-By" value="Marcello"/>
			</manifest>
		</jar>
		<jar 
			jarfile="${dist.version}/exttest-ext.jar"
			includes="cello/demo/jtablet/ext/ExtClass.class"
	    	level="9"
	    	basedir="${build.demo}">
			<manifest>
				<attribute name="Built-By" value="Marcello"/>
				<attribute name="Extension-Name" value="exttest"/>
				<attribute name="Specification-Vendor" value="exttest"/>
				<attribute name="Specification-Version" value="1.0"/>
				<attribute name="Implementation-Vendor-Id" value="exttest"/>
				<attribute name="Implementation-Vendor" value="exttest"/>
				<attribute name="Implementation-Version" value="1.0"/>

			</manifest>
		</jar>
		<jar 
			jarfile="${dist.version}/exttest-unused.jar"
			includes="cello/demo/jtablet/ext/ExtLoadingClass.class"
	    	level="9"
	    	basedir="${build.demo}">
			<manifest>
				<attribute name="Built-By" value="Marcello"/>

				<attribute name="Extension-List" value="exttest"/>
				<attribute name="exttest-Extension-Name" value="exttest"/>
				<attribute name="exttest-Specification-Version" value="1.0"/>
				<attribute name="exttest-Specification-Vendor" value="Cellosoft"/>
				<attribute name="exttest-Implementation-Version" value="1.0"/>
				<attribute name="exttest-Implementation-Vendor-Id" value="cello"/>
				<attribute name="exttest-Implementation-URL" value="http://sketchstudio.cellosoft.com/jtablet2/ext/exttest-ext.signed.jar"/>

			</manifest>
		</jar>
		<signjar 
			alias="jtablet2" 
			storepass="notsecureatall5936510"
			keypass="notsecureatall5936510"
	  		lazy="true"
	  		jar="${dist.version}/exttest-ext.jar"
	  		signedjar="${dist.version}/exttest-ext.signed.jar">
		</signjar>
	</target>


	<target name="jtablet.signed" depends="jtablet.jar">
		<signjar 
			alias="jtablet2" 
			storepass="notsecureatall5936510"
			keypass="notsecureatall5936510"
	  		lazy="true"
	  		jar="${dist.version}/jtablet2.original.jar"
	  		signedjar="${dist}/jtablet2.jar">
		</signjar>
	</target>

	<target name="demo.signed" depends="demo.jar">
		<signjar 
			alias="jtablet2" 
			storepass="notsecureatall5936510"
			keypass="notsecureatall5936510"
	  		lazy="true"
	  		jar="${dist.version}/jtablet2-demo.original.jar"
	  		signedjar="${dist}/jtablet2-demo.jar">
		</signjar>
	</target>

	<target name="installer.signed" depends="installer.jar">
		<signjar 

			alias="jtablet2" 
			storepass="notsecureatall5936510"
			keypass="notsecureatall5936510"
	  		lazy="true"
	  		jar="${dist.version}/jtablet2-installer.original.jar"
	  		signedjar="${dist}/jtablet2-installer.jar">
		</signjar>
	</target>

	<!--
  <target name="installer-dist" depends="signedjars">
    <mkdir dir="${dist}/installer"/>

	<filter token="buildVersion" value="${svn.version}"/>
	<copy todir="${dist}/installer" filtering="true">
		<fileset dir="html">
		  <include name="**/*"/>
		</fileset>
	</copy>
	<copy file="${dist}/signed/jtablet-installeroriginal.jar" tofile="${dist}/installer/jtablet-installer.jar" />
	<copy todir="${dist}/installer" file="lib/javascript.jar" />
  </target>
-->
	<target name="jars.signed" depends="jtablet.signed,demo.signed,installer.signed">
	</target>

	<target name="javadocs" depends="init" description="generates javadoc API documentation">
		<mkdir dir="${docs.api}"/>
		<javadoc
	        destdir="${docs.api}"
	        author="true"
	        version="true"
	        use="true"
			classpathref="jtablet.classpath"
			Overview="src/overview.html"
	        windowtitle="JTablet 2.0 API"
			Header="JTablet 2.0 API">

			<packageset dir="${src}" defaultexcludes="yes">
				<include name="cello/jtablet/**"/>
				<exclude name="cello/jtablet/impl/**"/>
			</packageset>
			<link href="http://java.sun.com/j2se/1.5.0/docs/api/" packagelistloc="java1.5-package-list"/>
		</javadoc>
	</target>

	<target name="jars.demo" depends="jtablet.compile,demo.compile">

		<jar 
		jarfile="html/demos/jtablet2-ext.jar"
		includes="cello/**"
    	level="9"
    	basedir="${build.jtablet}">
			<manifest>
				<attribute name="Built-By" value="Marcello"/>
				<attribute name="Sealed" value="true"/>


				<attribute name="Extension-Name" value="cello.jtablet2"/>
				<attribute name="Specification-Vendor" value="Cellosoft"/>
				<attribute name="Specification-Version" value="2.0"/>
				<attribute name="Implementation-Vendor-Id" value="cello"/>
				<attribute name="Implementation-Vendor" value="Cellosoft"/>
				<attribute name="Implementation-Version" value="2.0"/>

			</manifest>
		</jar>
		<jar 
			jarfile="html/demos/jtablet2-demo.jar"
			includes="cello/**"
	    	level="9"
	    	basedir="${build.demo}">
			<manifest>
				<attribute name="Main-Class" value="cello.demo.jtablet.DemoApplet.class" />
				<attribute name="Built-By" value="JTablet 2.0 build script"/>
			</manifest>
		</jar>
		<jar 
			jarfile="html/demos/jtablet2-demo-ext.jar"
			includes="cello/**"
	    	level="9"
	    	basedir="${build.demo}">
			<manifest>
				<attribute name="Main-Class" value="cello.demo.jtablet.DemoApplet.class" />
				<attribute name="Built-By" value="JTablet 2.0 build script"/>

				<attribute name="Extension-List" value="jtablet2 jpen2"/>
				<attribute name="jtablet2-Extension-Name" value="cello.jtablet2"/>
				<attribute name="jtablet2-Specification-Version" value="1.9"/>
				<attribute name="jtablet2-Specification-Vendor" value="Cellosoft"/>
				<attribute name="jtablet2-Implementation-Version" value="1.9"/>
				<attribute name="jtablet2-Implementation-Vendor-Id" value="cello"/>
				<attribute name="jtablet2-Implementation-URL" value="http://sketchstudio.cellosoft.com/jtablet2/ext/jtablet2-ext.signed.jar"/>

				<attribute name="jpen2-Extension-Name" value="jpen"/>
				<attribute name="jpen2-Specification-Version" value="2.0"/>
				<attribute name="jpen2-Specification-Vendor" value="jpen"/>
				<attribute name="jpen2-Implementation-Version" value="2.0"/>
				<attribute name="jpen2-Implementation-Vendor-Id" value="jpen"/>
				<attribute name="jpen2-Implementation-URL" value="http://sketchstudio.cellosoft.com/jtablet2/ext/jpen2-ext.signed.jar"/>
			</manifest>
		</jar>


	</target>
	<target name="jars.demo.signed" depends="jars.demo">
		<signjar 
			alias="jtablet2" 
			storepass="notsecureatall5936510"
			keypass="notsecureatall5936510"
	  		lazy="true"
	  		jar="html/demos/jtablet2-ext.jar"
	  		signedjar="html/demos/jtablet2-ext.signed.jar">
		</signjar>
		<signjar 
			alias="jtablet2" 
			storepass="notsecureatall5936510"
			keypass="notsecureatall5936510"
	  		lazy="true"
	  		jar="html/demos/jpen2-ext.jar"
	  		signedjar="html/demos/jpen2-ext.signed.jar">
		</signjar>
	</target>


	<target name="clean" description="clean up" >
		<delete dir="${src.gen}"/>
		<delete dir="${src.gen.thin}"/>

		<!-- Delete the ${build.jtablet} and ${dist} directory trees -->
		<delete dir="${build.jtablet}"/>
		<delete dir="${build.jtablet.jpen}"/>
		<delete dir="${build.jtablet.thin}"/>
		<delete dir="${build.demo}"/>
		<delete dir="${build.installer}"/>
		<!--
    <delete dir="${dist}/installer"/>
  	<delete file="${dist.version}/jtablet2.original.jar"/>
    <delete file="${dist}/jtablet2.jar"/>
    -->
	</target>
</project>
