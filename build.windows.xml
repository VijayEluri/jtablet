<!--  Platform-specific build targets for Windows -->
<project>	
	<property environment="env" />
	<property name="jdk.classes.jar" 	location="${java.home}/lib/rt.jar" />
	<property name="gcc"				location="/mingw/bin/gcc" />
	<property name="makensis"           location="/Program Files/NSIS/makensis" />
	<property name="ext.dir"			location="${env.WINDIR}\Sun\Java\lib\ext"/>
    <property name="dll.dir"            location="${env.WINDIR}\Sun\Java\lib\bin"/>

	<property name="jdk.home"			location="\java\jdk1.6" />

	<target name="jtabletjpen.gen.native">
	   <fail message="imported file run without parent"/>
	</target>
	<target name="jtablet.jar">
	   <fail message="imported file run without parent"/>
	</target>
	
	<target name="jtablet.install" depends="jtablet.jar,jtabletjpen.compile.native"
		description="Ant-based installation to ${ext.dir} and ${dll.dir}">
		<mkdir dir="${ext.dir}"/>
		<mkdir dir="${dll.dir}"/>
        <copy 
			file="${dist.version}/jtablet.jar" 
			todir="${ext.dir}"/>
		<copy 
			file="${dist.version}/jtablet2.dll" 
			todir="${dll.dir}"/>
	</target>



	<target name="jtablet.uninstall"
		description="Manually remove JTablet jar and dll.">
        <delete file="${dll.dir}\jtablet2.dll" failonerror="true"/>
		<delete file="${ext.dir}\jtablet.jar" failonerror="true"/>
	</target>

	

	<target name="jtabletjpen.compile.native" depends="jtabletjpen.gen.native" description="compile the jpen native source for windows" >
		<exec
	    	executable="${gcc}"
		    	failonerror="true"
		    	dir="${src.gen.native}/windows">
			<arg value="-Wall"/>
			<arg value="-c"/>
			<arg value="-mrtd"/>
			<arg value="-D_JNI_IMPLEMENTATION"/>
			<arg value="-I${jdk.home}/include"/>
			<arg value="-I${jdk.home}/include/win32"/>
			<arg value="*.c"/>
		</exec>
		<exec
	    	executable="${gcc}"
		    	failonerror="true"
		    	dir="${src.gen.native}/windows">
			<arg value="-Wall"/>
			<arg value="-Wl,--kill-at"/>
			<arg value="-shared"/>
			<arg value="-o"/>
			<arg value="jtablet2.dll"/>
			<arg value="*.o"/>
			<arg value="-Llib"/>
			<arg value="-lWintab32"/>
		</exec>
		<copy tofile="${dist.version}/jtablet2.dll">
			<fileset dir="${src.gen.native}/windows">
				<include name="*.dll"/>
			</fileset>
		</copy>
	</target>

	<target name="jtabletjpen.compile.64" depends="jtabletjpen.gen.native" description="compile the jpen native source for windows (64-bit)" >
		<exec
	    	executable="${gcc}"
		    	failonerror="true"
		    	dir="${src.gen.native}/windows">
			<arg value="-Wall"/>
			<arg value="-c"/>
			<arg value="-mrtd"/>
			<arg value="-D_JNI_IMPLEMENTATION"/>
			<arg value="-I${jdk.home}/include"/>
			<arg value="-I${jdk.home}/include/win32"/>
			<arg value="*.c"/>
		</exec>
		<exec
	    	executable="${gcc}"
		    	failonerror="true"
		    	dir="${src.gen.native}/windows">
			<arg value="-Wall"/>
			<arg value="-Wl,--kill-at"/>
			<arg value="-shared"/>
			<arg value="-o"/>
			<arg value="jtablet2-64.dll"/>
			<arg value="*.o"/>
			<arg value="-Llib-64"/>
			<arg value="-lWintab64"/>
		</exec>
		<copy tofile="${dist.version}/jtablet2-64.dll">
			<fileset dir="${src.gen.native}/windows">
				<include name="*.dll"/>
			</fileset>
		</copy>
	</target>
	
    <target name="jtablet.installer" 
        depends="jtablet.jar,jtabletjpen.compile.native"
    	description="Builds the Windows installer using NSIS">
        
        <property name="installer.dir" location="${dist.version}/${platform}/" />
        
        <mkdir dir="${installer.dir}"/>
        
        <copy todir="${installer.dir}">
            <fileset dir="platform/${platform}" />
        </copy>
        
        <replace dir="${installer.dir}">
            <replacefilter
                token="%%JTABLET.VERSION%%"
                value="${impl.version}"/>
        </replace>
        
        <copy todir="${installer.dir}/InstallFiles">
            <fileset dir="${dist.version}">
                <include name="jtablet.jar" />
                <include name="jtablet*.dll" />
            </fileset>
        </copy>
        
        <exec
            executable="${makensis}"
            failonerror="true"
            dir="${installer.dir}">
            <arg value="/V2"/>
            <arg value="Installer.nsi"/>
        </exec>
        
        <copy 
            file="${installer.dir}/JTabletSetup.exe"
            tofile="${dist.version}/JTabletSetup-${impl.version}.exe"/>
    </target>
</project>